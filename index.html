<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç”Ÿæ—¥å ±ç´™æ‹è²¼æ©Ÿ - ä¿®æ­£ç‰ˆ</title>
<style>
body {
font-family: sans-serif;
display: flex;
flex-direction: column;
align-items: center;
background-color: #222;
color: white;
margin: 0;
padding: 20px;
}

/* å¤–æ¡†å®¹å™¨ï¼šä¿æŒåŸå§‹æ¯”ä¾‹ï¼Œä¸å£“ç¸® */
.container {
position: relative;
width: fit-content;
max-width: 95vw;
max-height: 80vh;
background: #000;
overflow: hidden;
box-shadow: 0 0 20px rgba(0,0,0,0.5);
line-height: 0;
}

/* å ±ç´™æ¡†ï¼šä½¿ç”¨ auto ç¢ºä¿ä¸è¢«å£“ç¸® */
#frame-overlay {
display: block;
width: auto;
height: auto;
max-width: 100%;
max-height: 80vh;
position: relative;
z-index: 10;
pointer-events: none;
}

/* æ”å½±æ©Ÿç•«é¢ï¼šçµ•å°å®šä½åœ¨æ¡†çš„ä¸‹æ–¹ */
#video {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
object-fit: cover; /* è®“ç›¸æ©Ÿå¡«æ»¿æ¡†æ ¼è€Œä¸è®Šå½¢ */
transform: scaleX(-1); /* é¡åƒé è¦½ */
z-index: 5;
}

.controls {
margin-top: 20px;
display: flex;
flex-direction: column;
align-items: center;
gap: 10px;
}

button {
padding: 15px 40px;
font-size: 18px;
cursor: pointer;
background-color: #f1c40f;
color: #000;
border: none;
border-radius: 30px;
font-weight: bold;
}

#status-msg {
font-size: 14px;
color: #ff6b6b;
}
</style>
</head>
<body>

<h2>ğŸ“¸ å ±ç´™æ‹è²¼æ©Ÿ</h2>

<div class="container" id="booth">
<video id="video" autoplay playsinline></video>
<img id="frame-overlay" src="frame.png" alt="è¼‰å…¥ä¸­...">
</div>

<div class="controls">
<div id="status-msg"></div>
<button id="snap-btn">æ‹ç…§ä¸¦å„²å­˜</button>
</div>

<canvas id="canvas-hidden" style="display:none;"></canvas>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas-hidden');
const frameImg = document.getElementById('frame-overlay');
const snapBtn = document.getElementById('snap-btn');
const statusMsg = document.getElementById('status-msg');

// 1. åµæ¸¬ç’°å¢ƒä¸¦å•Ÿå‹•ç›¸æ©Ÿ
async function init() {
// æª¢æŸ¥æ˜¯å¦ç‚ºæœ¬åœ°æª”æ¡ˆé–‹å•Ÿ (file://)
if (window.location.protocol === 'file:') {
statusMsg.innerText = "âŒ åµæ¸¬åˆ°æ‚¨ç›´æ¥æ‰“é–‹ HTML æª”æ¡ˆã€‚è«‹ä½¿ç”¨ Live Server æˆ–ä¸Šå‚³åˆ°ç¶²é ç©ºé–“ï¼Œå¦å‰‡ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿã€‚";
return;
}

try {
const stream = await navigator.mediaDevices.getUserMedia({
video: {
width: { ideal: 1920 },
height: { ideal: 1080 },
facingMode: "user"
}
});
video.srcObject = stream;
} catch (err) {
statusMsg.innerText = "âŒ ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿã€‚è«‹æª¢æŸ¥æ¬Šé™æˆ–ç¢ºä¿ç¶²å€æ˜¯ HTTPSã€‚";
console.error(err);
}
}

// 2. æ‹ç…§ä¸‹è¼‰é‚è¼¯
snapBtn.addEventListener('click', () => {
if (!video.srcObject) {
alert("ç›¸æ©Ÿå°šæœªå•Ÿå‹•ï¼");
return;
}

const ctx = canvas.getContext('2d');

// ä»¥ã€Œæ¡†ã€çš„åŸå§‹å¤§å°ä½œç‚ºè¼¸å‡ºè§£æåº¦
const w = frameImg.naturalWidth;
const h = frameImg.naturalHeight;
canvas.width = w;
canvas.height = h;

// è¨ˆç®—ç›¸æ©Ÿç•«é¢å¡«æ»¿æ¯”ä¾‹ (Cover é‚è¼¯)
const videoW = video.videoWidth;
const videoH = video.videoHeight;
const vRatio = videoW / videoH;
const cRatio = w / h;

let dW, dH, dx, dy;
if (vRatio > cRatio) {
dH = h;
dW = h * vRatio;
dx = (dW - w) / 2;
dy = 0;
} else {
dW = w;
dH = w / vRatio;
dx = 0;
dy = (dH - h) / 2;
}

// A. ç•«ç›¸æ©Ÿç•«é¢ (é¡åƒè™•ç†)
ctx.save();
ctx.translate(w, 0);
ctx.scale(-1, 1);
ctx.drawImage(video, -dx, -dy, dW, dH);
ctx.restore();

// B. ç–ŠåŠ å ±ç´™æ¡†
ctx.drawImage(frameImg, 0, 0, w, h);

// C. ä¸‹è¼‰
try {
const link = document.createElement('a');
link.download = `Birthday_Photo_${Date.now()}.png`;
link.href = canvas.toDataURL('image/png', 1.0);
link.click();
} catch (e) {
alert("å­˜æª”å¤±æ•—ï¼š" + e.message);
}
});

// åˆå§‹åŒ–
frameImg.onload = init;
if (frameImg.complete) init();
</script>
</body>
</html>